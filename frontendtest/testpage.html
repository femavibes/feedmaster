<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feedmaster Test Page - Dynamic Feed ID</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 1600px; /* Wider layout for two columns */
            margin: 30px auto;
            background-color: #ffffff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 25px;
            font-size: 2em;
        }
        .feed-control {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: 15px; /* Increased gap */
            margin-bottom: 25px;
            align-items: center;
            justify-content: center;
            background-color: #e9f5ff;
            border-left: 5px solid #2196f3;
            padding: 15px;
            border-radius: 5px;
        }
        .feed-control label {
            font-weight: bold;
            color: #3f51b5;
        }
        .feed-control input[type="text"],
        .feed-control select {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
            width: 150px;
        }
        .feed-control input[type="search"] {
            width: 250px; /* Wider search bar */
            flex-grow: 1;
            max-width: 400px;
        }
        .feed-control button {
            padding: 8px 15px;
            background-color: #2196f3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease;
        }
        .feed-control button:hover {
            background-color: #1976d2;
        }
        .feed-info {
            background-color: #e9f5ff;
            border-left: 5px solid #2196f3;
            padding: 15px;
            margin-bottom: 25px;
            border-radius: 5px;
            font-size: 1.1em;
            color: #3f51b5;
        }
        .search-results-section {
            margin-top: 25px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }
        .section-title {
            color: #2c3e50;
            margin-top: 30px;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid #e0e0e0;
            font-size: 1.5em;
        }
        
        /* --- NEW TWO-COLUMN LAYOUT --- */
        .main-content-grid {
            display: grid;
            grid-template-columns: 420px 1fr; /* Fixed left column, flexible right column */
            gap: 25px;
            align-items: start; /* Align content to the top */
        }

        .posts-column {
            position: sticky; /* Makes the column 'stick' in place */
            top: 30px; /* Space from the top of the viewport */
            height: calc(100vh - 60px); /* Full vertical height, minus top/bottom margin */
            display: flex;
            flex-direction: column;
        }

        .posts-column .section-title {
            margin-top: 0;
        }

        /* Grid for Aggregates (Right Column) */
        .aggregates-grid {
            display: grid;
            /* Keeps the 3-wide layout */
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px; /* Gap between aggregate sections */
        }

        /* Individual aggregate sections within the grid */
        .aggregate-section {
            background-color: #fcfcfc; /* Lighter background for individual sections */
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }
        .aggregate-section .section-title {
            margin-top: 0;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 10px;
            margin-bottom: 10px;
            font-size: 1.2em;
            text-align: center;
        }

        /* Add scrollbars to individual aggregate containers */
        .aggregate-section > div[id$='-container'] {
            max-height: 450px;
            overflow-y: auto;
            padding-right: 8px; /* Space for the scrollbar */
        }

        /* Recent Posts List (Left Column) */
        .posts-grid {
            display: grid;
            grid-template-columns: 1fr; /* Change to a single column layout */
            overflow-y: auto; /* Enable vertical scrolling */
            flex-grow: 1; /* Allow it to fill the available space in the column */
            gap: 20px;
        }
        .post-card {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .post-card:hover {
            transform: translateY(-5px);
        }
        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }
        .author-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .author-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        .author-info div {
            display: flex;
            flex-direction: column;
        }
        .author-info strong {
            color: #333;
        }
        .post-text {
            font-size: 1em;
            margin-bottom: 15px;
            flex-grow: 1;
            word-wrap: break-word; /* Ensure long text breaks */
        }
        .post-text a {
            color: #1b74e4;
            text-decoration: none;
            font-weight: 500;
        }
        .post-text a:hover {
            text-decoration: underline;
        }
        .post-engagement {
            font-size: 0.85em;
            color: #777;
            text-align: right;
            margin-top: 10px;
        }
        .post-engagement span {
            margin-left: 15px;
            display: inline-flex;
            align-items: center;
        }
        .post-engagement span::before {
            margin-right: 5px;
        }
        .icon-heart::before { content: '‚ù§Ô∏è'; }
        .icon-repost::before { content: 'üîÑ'; }
        .icon-reply::before { content: 'üí¨'; }
        .icon-quote::before { content: 'üó®Ô∏è'; }
        .error-message {
            color: #d32f2f;
            background-color: #ffebee;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ef9a9a;
            font-weight: bold;
            text-align: center;
            margin-top: 20px;
        }
        .loading {
            text-align: center;
            padding: 30px;
            font-size: 1.2em;
            color: #555;
        }
        .aggregate-list {
            list-style: none;
            padding: 0;
            margin-top: 10px;
        }
        .aggregate-list li {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            margin-bottom: 8px;
            padding: 10px 15px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .aggregate-list li strong {
            color: #333;
        }
        .aggregate-list li span.count {
            background-color: #e0eaff;
            color: #3f51b5;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.9em;
        }
        .aggregate-list li img {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
        }
        /* Make links within aggregate lists wrap */
        .aggregate-list li a {
            word-break: break-all;
        }
        .resolve-btn {
            margin-left: 10px;
            padding: 2px 6px;
            font-size: 0.8em;
            cursor: pointer;
            border: 1px solid #aaa;
            background-color: #f0f0f0;
            border-radius: 3px;
        }
        .resolve-btn:hover {
            background-color: #e0e0e0;
        }

/* --- NEW: Styles for Media Grid --- */
.media-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 10px;
    padding-top: 10px;
}
.media-item {
    position: relative;
    width: 100%;
    padding-top: 100%; /* Creates a 1:1 aspect ratio box */
    overflow: hidden;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.media-item img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.2s ease-in-out;
}
.media-item:hover img {
    transform: scale(1.05);
}
/* New styles for video placeholders */
.video-placeholder {
    background-color: #2c3e50; /* Dark slate background */
    display: flex;
    justify-content: center;
    align-items: center;
    color: white;
    text-decoration: none;
    /* The play icon inside a placeholder should be visible */
    opacity: 0.9;
}
.media-item .play-icon {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 2.5em;
    color: white;
    opacity: 0; /* Hidden by default, shown on hover */
    transition: all 0.2s ease;
    text-shadow: 0 0 10px rgba(0,0,0,0.7);
    pointer-events: none; /* So it doesn't interfere with the link click */
}
/* Show icon on hover, or if it's a placeholder without an image */
.media-item:hover .play-icon,
.video-placeholder .play-icon {
    opacity: 0.9;
}
.media-item:hover .play-icon {
    transform: translate(-50%, -50%) scale(1.1);
}
/* Dim the image on hover to make the play icon stand out */
.media-item:hover img {
    filter: brightness(0.7);
}
/* New badge for multiple images */
.image-count-badge {
    position: absolute;
    top: 5px;
    right: 5px;
    background-color: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 0.75em;
    font-weight: bold;
}

/* --- NEW: Styles for User Profile Modal --- */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    display: none; /* Hidden by default */
    justify-content: center;
    align-items: center;
    z-index: 1000;
}
.modal-container {
    background-color: #ffffff;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    width: 95%;
    max-width: 1200px; /* Widen the modal for the new layout */
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    position: relative;
}
.modal-header {
    display: flex;
    align-items: center;
    gap: 20px;
    border-bottom: 1px solid #e0e0e0;
    padding-bottom: 20px;
    margin-bottom: 20px;
}
.modal-header img {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
}
.modal-header .user-details h3 {
    margin: 0;
    font-size: 1.8em;
    color: #2c3e50;
}
.modal-header .user-details p {
    margin: 5px 0 0;
    color: #666;
    font-size: 1.1em;
}
.modal-close-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    font-size: 2em;
    color: #aaa;
    cursor: pointer;
    border: none;
    background: none;
    line-height: 1;
}
.modal-close-btn:hover {
    color: #333;
}
.modal-body {
    overflow-y: auto;
    padding-right: 15px; /* space for scrollbar */
}
.modal-grid-body {
    display: grid;
    grid-template-columns: 1fr 1fr; /* Two equal columns */
    gap: 30px; /* Gap between columns */
    align-items: start;
}
.modal-grid-column {
    display: flex;
    flex-direction: column;
    gap: 25px; /* Gap between sections in a column */
}
.modal-section {
    margin-bottom: 25px;
}
.rarity-label {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75em;
    font-weight: bold;
    margin-left: 8px;
    color: white;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.rarity-bronze { background-color: #cd7f32; }
.rarity-silver { background-color: #c0c0c0; color: #333; }
.rarity-gold { background-color: #ffd700; color: #333; }
.rarity-platinum { background-color: #e5e4e2; color: #333; }
.rarity-diamond { background-color: #b9f2ff; color: #333; }
.rarity-legendary { background-color: #9400d3; }
.rarity-mythic {
    background: linear-gradient(45deg, #ff00ff, #ff9900, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff);
    background-size: 400% 400%;
    animation: gradient 5s ease infinite;
}
.scrollable-list {
    max-height: 350px; /* Increased height for better space utilization */
    overflow-y: auto;
}

.progress-bar-container {
    width: 100%;
    background-color: #e9ecef;
    border-radius: 12px;
    height: 12px;
    margin-top: 8px;
    overflow: hidden;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
}
.progress-bar {
    height: 100%;
    background-color: #2196f3;
    border-radius: 12px;
    transition: width 0.4s ease-in-out;
    text-align: right;
}

@keyframes gradient {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}
.admin-nav { background-color: #fff; padding: 1rem 2rem; border-bottom: 1px solid #e0e0e0; margin: -25px -25px 25px -25px; border-radius: 10px 10px 0 0; }
.admin-nav ul { list-style: none; padding: 0; margin: 0; display: flex; gap: 1.5rem; }
.admin-nav a { color: #2c3e50; text-decoration: none; font-weight: 600; }
.admin-nav a:hover { color: #3f51b5; }
.admin-nav a.active { color: #3f51b5; }
    </style>
    <style>
        /* --- NEW: Pagination Styles --- */
        .pagination-controls { text-align: center; padding-top: 15px; border-top: 1px solid #e0e0e0; margin-top: 15px; }
        .pagination-controls button { padding: 8px 15px; background-color: #f0f2f5; color: #333; border: 1px solid #ccc; border-radius: 5px; cursor: pointer; font-size: 1em; transition: background-color 0.2s ease; margin: 0 5px; }
        .pagination-controls button:hover:not(:disabled) { background-color: #e0e0e0; }
        .pagination-controls button:disabled { background-color: #f8f9fa; color: #aaa; cursor: not-allowed; }
        .pagination-controls .page-info {
            margin: 0 15px;
            font-weight: bold;
            color: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="admin-nav">
            <ul>
                <li><a href="/leaderboards">Leaderboards</a></li>
                <li><a href="/testpage" class="active">Test Page</a></li>
            </ul>
        </nav>
        <h1>Feedmaster: Dynamic Feed Data</h1>
        <div class="feed-control">
            <label for="feedSelect">Select Feed:</label>
            <select id="feedSelect">
                <option value="3654">Urbanism+ (3654)</option>
                <option value="5511">Transitsky (5511)</option>
            </select>

            <label for="timeframeSelect">Timeframe:</label>
            <select id="timeframeSelect">
                <option value="1h">1 Hour</option>
                <option value="6h">6 Hours</option>
                <option value="1d" selected>1 Day</option>
                <option value="7d">7 Days</option>
                <option value="30d">30 Days</option>
                <option value="allTime">All Time</option>
            </select>

            <label for="searchInput">Search:</label>
            <input type="search" id="searchInput" placeholder="Search for users by handle or name...">

            <button id="loadDataBtn">Load Data</button>
        </div>

        <!-- NEW: Search Results Section -->
        <div id="search-results-container" class="search-results-section" style="display: none;">
            <h2 class="section-title" id="search-results-title">Search Results</h2>
            <div id="search-results-content"></div>
        </div>

        <!-- New Main Grid Layout -->
        <div class="main-content-grid">
            <!-- Left Column: Recent Posts -->
            <div class="posts-column">
                <h2 class="section-title">Recent Posts</h2>
                <div id="posts-container" class="posts-grid">
                    <p class="loading">Please enter a Feed ID and click "Load Data".</p>
                </div>
            </div>

            <!-- Right Column: Aggregates -->
            <div class="aggregates-column">
                <div class="aggregates-grid">

                    <div class="aggregate-section">
                        <h2 class="section-title">Top Posts</h2>
                        <div id="top-posts-container">
                            <p class="loading">Loading Top Posts...</p>
                        </div>
                    </div>

                    <div class="aggregate-section">
                        <h2 class="section-title">Top Hashtags</h2>
                        <div id="top-hashtags-container">
                            <p class="loading">Loading Top Hashtags...</p>
                        </div>
                    </div>

                    <div class="aggregate-section">
                        <h2 class="section-title">Top Users</h2>
                        <div id="top-users-container">
                            <p class="loading">Loading Top Users...</p>
                        </div>
                    </div>

                    <div class="aggregate-section">
                        <h2 class="section-title">Top Posters by Count</h2>
                        <div id="top-posters-by-count-container">
                            <p class="loading">Loading Top Posters by Count...</p>
                        </div>
                    </div>

                    <div class="aggregate-section">
                        <h2 class="section-title">Top Mentions</h2>
                        <div id="top-mentions-container">
                            <p class="loading">Loading Top Mentions...</p>
                        </div>
                    </div>

                    <div class="aggregate-section">
                        <h2 class="section-title">Top Domains</h2>
                        <div id="top-domains-container">
                            <p class="loading">Loading Top Domains...</p>
                        </div>
                    </div>

                    <div class="aggregate-section">
                        <h2 class="section-title">Top Countries</h2>
                        <div id="top-countries-container">
                            <p class="loading">Loading Top Countries...</p>
                        </div>
                    </div>

                    <div class="aggregate-section">
                        <h2 class="section-title">Top Regions</h2>
                        <div id="top-regions-container">
                            <p class="loading">Loading Top Regions...</p>
                        </div>
                    </div>

                    <div class="aggregate-section">
                        <h2 class="section-title">Top Cities</h2>
                        <div id="top-cities-container">
                            <p class="loading">Loading Top Cities...</p>
                        </div>
                    </div>

                    <div class="aggregate-section">
                        <h2 class="section-title">Top Videos</h2>
                        <div id="top-videos-container">
                            <p class="loading">Loading Top Videos...</p>
                        </div>
                    </div>

                    <div class="aggregate-section">
                        <h2 class="section-title">Top Images</h2>
                        <div id="top-images-container">
                            <p class="loading">Loading Top Images...</p>
                        </div>
                    </div>

                    <div class="aggregate-section">
                        <h2 class="section-title">Top Links</h2>
                        <div id="top-links-container">
                            <p class="loading">Loading Top Links...</p>
                        </div>
                    </div>

                    <div class="aggregate-section">
                        <h2 class="section-title">Top Link Cards</h2>
                        <div id="top-link-cards-container">
                            <p class="loading">Loading Top Link Cards...</p>
                        </div>
                    </div>

                    <div class="aggregate-section">
                        <h2 class="section-title">Top News Link Cards</h2>
                        <div id="top-news-link-cards-container">
                            <p class="loading">Loading Top News Link Cards...</p>
                        </div>
                    </div>

                    <div class="aggregate-section">
                        <h2 class="section-title">Longest Streaks (All Time)</h2>
                        <div id="longest-poster-streaks-container">
                            <p class="loading">Loading Longest Poster Streaks...</p>
                        </div>
                    </div>

                    <div class="aggregate-section">
                        <h2 class="section-title">Active Streaks (All Time)</h2>
                        <div id="active-poster-streaks-container">
                            <p class="loading">Loading Active Poster Streaks...</p>
                        </div>
                    </div>

                    <div class="aggregate-section">
                        <h2 class="section-title">First-Time Posters</h2>
                        <div id="first-time-posters-container">
                            <p class="loading">Loading First-Time Posters...</p>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </div>

    <!-- NEW: User Profile Modal -->
    <div id="user-profile-modal" class="modal-overlay">
        <div class="modal-container">
            <button class="modal-close-btn" onclick="closeUserProfileModal()">&times;</button>
            <div id="modal-content-area">
                <!-- Content will be dynamically inserted here -->
                <div class="loading" style="padding: 50px;">
                    <p>Loading user profile...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: Hashtag Explorer Modal -->
    <div id="hashtag-explorer-modal" class="modal-overlay">
        <div class="modal-container" style="max-width: 800px;"> <!-- A bit smaller than the user modal -->
            <button class="modal-close-btn" onclick="closeHashtagModal()">&times;</button>
            <div class="modal-header" style="flex-direction: column; justify-content: center; border-bottom: 1px solid #e0e0e0; padding-bottom: 15px; margin-bottom: 15px;">
                <h3 id="hashtag-modal-title" style="margin: 0; font-size: 1.8em; color: #2c3e50;"></h3>
                <p id="hashtag-modal-info" style="margin: 5px 0 0; font-size: 0.9em; color: #666;"></p>
            </div>
            <div id="hashtag-modal-body" class="modal-body">
                <!-- Post cards will be dynamically inserted here -->
                <div class="loading" style="padding: 50px;">
                    <p>Loading posts...</p>
                </div>
            </div>
            <div id="hashtag-modal-footer" class="pagination-controls">
                <!-- Pagination controls will be inserted here -->
            </div>
        </div>
    </div>

    <style>
        body.modal-open {
            overflow: hidden; /* Prevent background scrolling when modal is open */
        }
    </style>
    <script>
        const getApiBaseUrl = () => {
            const hostname = window.location.hostname;
            const isIpAddress = /^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(hostname);
            if (hostname === 'localhost' || hostname === '127.0.0.1' || isIpAddress) {
                return `http://${hostname}:8000`;
            }
            return `${window.location.protocol}//${hostname}`;
        };
        const API_BASE_URL = getApiBaseUrl();
        const API_PREFIX = '/api/v1';

        // --- Global state for hashtag counts ---
        let hashtagCounts = {};

        const feedSelect = document.getElementById('feedSelect');
        const timeframeSelect = document.getElementById('timeframeSelect');
        const loadDataBtn = document.getElementById('loadDataBtn');

        // --- Centralized Error Handler for Fetch Operations ---
        function handleFetchError(error, container, action, feedId = null) {
            const feedIdText = feedId ? ` for Feed ID ${feedId}` : '';
            console.error(`Error trying to ${action}${feedIdText}:`, error);

            let detailedMessage = error.message;
            // Provide a more helpful message for the common "Failed to fetch" error.
            if (error instanceof TypeError && error.message.toLowerCase().includes('failed to fetch')) {
                detailedMessage = `A network error occurred. This could be a CORS issue, the API server being down, or a network connectivity problem.
                    <br>Please ensure the backend API at <strong>${API_BASE_URL}</strong> is running and accessible from your browser.
                    <br>Check your browser's developer console (F12) for more specific error messages.`;
            }

            if (container) {
                container.innerHTML = `<p class="error-message">‚ùå Failed to ${action}: ${detailedMessage}</p>`;
            }
        }

        // --- Centralized Aggregate Configuration ---
        const AGGREGATE_CONFIGS = {
            'top_posts': { containerId: 'top-posts-container', dataKey: 'top', itemNameKey: 'text', countKey: 'engagement_score', fallbackMessage: 'Top Posts' },
            'top_hashtags': { containerId: 'top-hashtags-container', dataKey: 'hashtags', itemNameKey: 'hashtag', countKey: 'count', fallbackMessage: 'Top Hashtags' },
            'top_users': { containerId: 'top-users-container', dataKey: 'top', itemNameKey: 'handle', countKey: 'engagement_score', fallbackMessage: 'Top Users' },
            'top_posters_by_count': { containerId: 'top-posters-by-count-container', dataKey: 'posters', itemNameKey: 'handle', countKey: 'post_count', fallbackMessage: 'Top Posters by Count' },
            'top_mentions': { containerId: 'top-mentions-container', dataKey: 'top', itemNameKey: 'handle', countKey: 'mention_count', fallbackMessage: 'Top Mentions' },
            'top_domains': { containerId: 'top-domains-container', dataKey: 'top', itemNameKey: 'domain', countKey: 'count', fallbackMessage: 'Top Domains' },
            'top_countries': { containerId: 'top-countries-container', dataKey: 'top', itemNameKey: 'country', countKey: 'count', fallbackMessage: 'Top Countries' },
            'top_regions': { containerId: 'top-regions-container', dataKey: 'top', itemNameKey: 'region', countKey: 'count', fallbackMessage: 'Top Regions' },
            'top_cities': { containerId: 'top-cities-container', dataKey: 'top', itemNameKey: 'city', countKey: 'count', fallbackMessage: 'Top Cities' },
            'top_videos': { containerId: 'top-videos-container', renderer: 'media', dataKey: 'top', fallbackMessage: 'Top Videos' },
            'top_images': { containerId: 'top-images-container', renderer: 'media', dataKey: 'top', fallbackMessage: 'Top Images' },
            'top_links': { containerId: 'top-links-container', dataKey: 'links', itemNameKey: 'uri', countKey: 'count', fallbackMessage: 'Top Links' },
            'top_link_cards': { containerId: 'top-link-cards-container', dataKey: 'cards', renderer: 'link_cards', fallbackMessage: 'Top Link Cards' },
            'top_news_link_cards': { containerId: 'top-news-link-cards-container', dataKey: 'news_cards', renderer: 'link_cards', fallbackMessage: 'Top News Link Cards' },
            'longest_poster_streaks': { containerId: 'longest-poster-streaks-container', dataKey: 'streaks', itemNameKey: 'handle', countKey: 'longest_streak', fallbackMessage: 'Longest Poster Streaks', timeframe: 'allTime' },
            'active_poster_streaks': { containerId: 'active-poster-streaks-container', dataKey: 'streaks', itemNameKey: 'handle', countKey: 'longest_streak', fallbackMessage: 'Active Poster Streaks', timeframe: 'allTime' },
            'first_time_posters': { containerId: 'first-time-posters-container', dataKey: 'new_posters', itemNameKey: 'handle', countKey: 'first_post_at', fallbackMessage: 'First-Time Posters' },
        };

        // --- Generic Fetch and Render Aggregate Function ---
        async function fetchAndRenderAggregate(feedId, aggName, timeframe, containerId, dataKey, itemNameKey, countKey, fallbackMessage) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<p class="loading">Loading ${fallbackMessage.toLowerCase()} for Feed ID ${feedId}, Timeframe ${timeframe}...</p>`;

            try {
                const response = await fetch(`${API_BASE_URL}${API_PREFIX}/feeds/${feedId}/aggregates?agg_name=${aggName}&timeframe=${timeframe}`);
                if (!response.ok) {
                    const errorJson = await response.json().catch(() => ({}));
                    throw new Error(`HTTP error! Status: ${response.status}, Detail: ${errorJson.detail || 'Unknown error'}`);
                }
                const data = await response.json();

                let items;
                // Always look inside data_json for the aggregate data
                if (data && typeof data.data_json === 'object' && data.data_json !== null) {
                    items = data.data_json[dataKey];
                } else {
                    // Fallback if data_json is not present or not an object
                    console.warn(`Aggregate response for ${aggName} did not contain expected 'data_json' structure.`, data);
                    items = []; // Ensure 'items' is an array to prevent further errors
                }

                // --- NEW: Store hashtag counts for hover tooltips ---
                // If we are fetching top hashtags, store the counts in our global object.
                if (aggName === 'top_hashtags' && items) {
                    hashtagCounts = {}; // Clear previous counts on each load
                    items.forEach(item => {
                        hashtagCounts[item[itemNameKey]] = item[countKey];
                    });
                }

                if (!items || items.length === 0) {
                    container.innerHTML = `<p class="loading">No ${fallbackMessage.toLowerCase()} found for Feed ID ${feedId} in the last ${timeframe}.</p>`;
                    return;
                }

                const ul = document.createElement('ul');
                ul.classList.add('aggregate-list');
                items.forEach(item => {
                    const li = document.createElement('li');

                    let name = item[itemNameKey];
                    // Special handling for users/posters/mentions
                    if (item.handle && !item.handle.startsWith('unknown.')) {
                        const handle = item.handle;
                        const displayName = item.display_name;

                        const did = item.did;
                        const avatarUrl = item.avatar_url || 'https://via.placeholder.com/24';

                        const userContent = (displayName && displayName.trim() !== '')
                            ? `<div style="display: flex; flex-direction: column; line-height: 1.2;">
                                   <strong style="color: #333;">${displayName}</strong>
                                   <small style="color: #666;">@${handle}</small>
                               </div>`
                            : `<div style="display: flex; align-items: center;"><strong style="color: #333;">@${handle}</strong></div>`;
                        
                        name = `<a href="javascript:void(0)" onclick="openUserProfileModal({ did: '${did}', handle: '${handle}', displayName: '${(displayName || '').replace(/'/g, "\\'")}', avatarUrl: '${avatarUrl}' })" style="text-decoration: none; color: inherit; display: flex; align-items: center;">
                                    <img src="${avatarUrl}" alt="Avatar" style="width:24px; height:24px; border-radius:50%; margin-right:8px; vertical-align: middle;">
                                    ${userContent}
                                </a>`;
                    } else if (item.did) { // Fallback if handle isn't available or is an unresolved "unknown." handle
                        const did = item.did;
                        // The button is intentionally outside the link, and we wrap them in a flex div to keep them on one line.
                        name = `<div style="display: flex; align-items: center; width: 100%;">
                                    <a href="https://bsky.app/profile/${did}" target="_blank" style="text-decoration: none; color: inherit; display: flex; align-items: center; flex-grow: 1; min-width: 0;">
                                        <img src="${item.avatar_url || 'https://via.placeholder.com/24'}" alt="Avatar" style="width:24px; height:24px; border-radius:50%; margin-right:8px; vertical-align: middle;">
                                        <span style="word-break: break-all;">${did}</span>
                                    </a>
                                    <button class="resolve-btn" onclick="requestProfileResolution('${did}', this)">Re-resolve</button>
                                </div>`;
                    }

                    // Special handling for links to make them clickable.
                    // Other types like media/cards are handled by their own renderers.
                    if (item.uri && aggName === 'top_links') {
                        name = `<a href="${item.uri}" target="_blank" style="word-break: break-all;">${item.uri.length > 70 ? item.uri.substring(0, 67) + '...' : item.uri}</a>`;
                    }

                    // Special handling for hashtags to make them clickable search links.
                    if (aggName === 'top_hashtags') {
                        const hashtag = item[itemNameKey];
                        name = `<a href="https://bsky.app/search?q=${encodeURIComponent('#' + hashtag)}" target="_blank">#${hashtag}</a>`;
                    }

                    li.innerHTML = `
                        <div>
                            ${name}
                        </div>
                        <span class="count">${
                            // Special formatting for dates vs. numbers
                            aggName === 'first_time_posters'
                            ? new Date(item[countKey]).toLocaleDateString()
                            : item[countKey]
                        }</span>
                    `;
                    ul.appendChild(li);
                });
                container.innerHTML = '';
                container.appendChild(ul);

            } catch (error) {
                handleFetchError(error, container, `load ${fallbackMessage.toLowerCase()}`, feedId);
            }
        }

        // --- NEW: Function to linkify mentions in post text ---
        // --- UPDATED: Now also linkifies hashtags ---
        function linkifyPostText(text) {
            if (!text) return 'No content.';

            // Start with the raw text. We will linkify first, then handle newlines.
            let htmlText = text;

            // 1. Linkify @-mentions. This regex finds handles preceded by whitespace or at the start of the string.
            const mentionRegex = /(^|\s)(@([a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,63})/g;
            htmlText = htmlText.replace(mentionRegex, (match, precedingWhitespace, fullMention) => {
                const handle = fullMention.substring(1); // remove '@'
                // This link opens our user profile modal and stops the click from bubbling up to the parent post link.
                const link = `<a href="javascript:void(0)" onclick="event.stopPropagation(); showUserProfileByHandle('${handle}')">${fullMention}</a>`;
                return precedingWhitespace + link;
            });

            // 2. Linkify #-hashtags. This regex finds valid tags preceded by whitespace or at the start.
            const hashtagRegex = /(^|\s)(#([a-zA-Z0-9_][a-zA-Z0-9_-]*))/g;
            htmlText = htmlText.replace(hashtagRegex, (match, precedingWhitespace, fullHashtag, tagName) => {
                // --- NEW: Add tooltip with hashtag frequency ---
                const count = hashtagCounts[tagName.toLowerCase()]; // Use toLowerCase for case-insensitive matching
                const timeframeText = timeframeSelect.options[timeframeSelect.selectedIndex].text;
                const titleAttr = count !== undefined
                    ? `title="Used ${count} time${count === 1 ? '' : 's'} in this feed (${timeframeText}). Click to explore."`
                    : 'title="Click to explore this hashtag."';
                // This link now opens our internal hashtag explorer modal.
                const link = `<a href="javascript:void(0)" ${titleAttr} onclick="event.stopPropagation(); openHashtagModal('${tagName}')">${fullHashtag}</a>`;
                return precedingWhitespace + link;
            });

            // 3. Finally, preserve newlines by converting them to <br> tags.
            return htmlText.replace(/\n/g, '<br>');
        }

        // --- NEW: Function to open user profile modal from a handle ---
        async function showUserProfileByHandle(handle) {
            // This function is called when a user clicks a mention in a post.
            // It uses the search API to find the user's full profile info,
            // then opens the standard user profile modal.
            const modal = document.getElementById('user-profile-modal');
            const contentArea = document.getElementById('modal-content-area');

            // Open the modal immediately to give user feedback.
            modal.style.display = 'flex';
            document.body.classList.add('modal-open');
            contentArea.innerHTML = `<div class="loading" style="padding: 50px;"><p>Looking up profile for @${handle}...</p></div>`;

            try {
                const response = await fetch(`${API_BASE_URL}${API_PREFIX}/search?q=${encodeURIComponent(handle)}`);
                if (!response.ok) {
                    const errorJson = await response.json().catch(() => ({}));
                    throw new Error(`HTTP error! Status: ${response.status}, Detail: ${errorJson.detail || 'Search failed'}`);
                }
                const data = await response.json();

                // The search can be broad, so we find the exact handle match.
                const user = data.users.find(u => u.handle.toLowerCase() === handle.toLowerCase());

                if (user) {
                    // If a user is found, map the API response (snake_case) to the object
                    // structure expected by openUserProfileModal (camelCase) to ensure consistency.
                    const userForModal = {
                        did: user.did,
                        handle: user.handle,
                        displayName: user.display_name,
                        avatarUrl: user.avatar_url
                    };
                    await openUserProfileModal(userForModal);
                } else {
                    // If no exact match is found, display a "not found" message in the modal.
                    contentArea.innerHTML = `
                        <div class="modal-header"><div class="user-details"><h3>User Not Found</h3><p>@${handle}</p></div></div><div class="modal-body"><p>This user could not be found in our database.</p><p>They may not have posted in any of the feeds we are tracking, or the handle may be incorrect.</p></div>`;
                }
            } catch (error) {
                handleFetchError(error, contentArea, `look up profile for @${handle}`);
            }
        }

        // --- NEW: Reusable function to create a post card element ---
        function createPostCardElement(post) {
            // The entire card is a clickable link to the post on Bluesky.
            const postLink = document.createElement('a');
            postLink.classList.add('post-card');

            // Construct the Bluesky URL for the post.
            const postRkey = post.uri.split('/').pop();
            // Use the author's handle if available, otherwise fall back to their DID.
            const authorIdentifier = post.author ? post.author.handle : post.author_did;
            postLink.href = `https://bsky.app/profile/${authorIdentifier}/post/${postRkey}`;
            postLink.target = '_blank'; // Open in a new tab
            postLink.style.textDecoration = 'none'; // Remove link underline
            postLink.style.color = 'inherit'; // Use the default text color
            
            const author = post.author;
            const createdAt = new Date(post.created_at).toLocaleString();

            const authorHtml = author ? `
                <div class="author-info">
                    <img src="${author.avatar_url || 'https://via.placeholder.com/40'}" alt="${author.handle}'s avatar">
                    <div>
                        ${(author.display_name && author.display_name.trim() !== '')
                            ? `<strong>${author.display_name}</strong><small>@${author.handle}</small>`
                            : `<strong>@${author.handle}</strong>`
                        }
                    </div>
                </div>
            ` : `
                <div class="author-info">
                    <span>Author DID: ${post.author_did || 'N/A'}</span>
                </div>
            `;

            postLink.innerHTML = `
                <div class="post-header">
                    ${authorHtml}
                    <small class="post-date">${createdAt}</small>
                </div>
                <div class="post-text">${linkifyPostText(post.text)}</div>
                <div class="post-engagement">
                    <span class="icon-heart">${post.like_count || 0}</span> <span class="icon-repost">${post.repost_count || 0}</span> <span class="icon-reply">${post.reply_count || 0}</span> <span class="icon-quote">${post.quote_count || 0}</span>
                </div>
                <small style="word-break: break-all; margin-top: 10px; color: #888;">URI: ${post.uri}</small>
            `;
            return postLink;
        }

        // --- Specific Fetch Posts Function ---
        async function fetchAndDisplayPosts(feedId) {
            const postsContainer = document.getElementById('posts-container');
            postsContainer.innerHTML = `<p class="loading">Loading posts for Feed ID ${feedId}...</p>`;

            try {
                const response = await fetch(`${API_BASE_URL}${API_PREFIX}/feeds/${feedId}/posts`);

                if (!response.ok) {
                    let errorDetail = `Status: ${response.status}`;
                    try {
                        const errorJson = await response.json();
                        if (errorJson.detail) {
                            errorDetail += `, Detail: ${errorJson.detail}`;
                        }
                    } catch (jsonError) {
                        errorDetail += `, Response: ${await response.text()}`;
                    }
                    throw new Error(`HTTP error! ${errorDetail}`);
                }

                const data = await response.json();
                const posts = data.posts;

                if (!posts || posts.length === 0) {
                    postsContainer.innerHTML = `<p class="loading">No posts found for Feed ID ${feedId}. Keep the workers running, or try a different FEED_ID.</p>`;
                    return;
                }

                postsContainer.innerHTML = '';

                posts.forEach(post => {
                    const postElement = createPostCardElement(post);
                    postsContainer.appendChild(postElement);
                });

            } catch (error) {
                handleFetchError(error, postsContainer, 'load posts', feedId);
            }
        }

        // --- New Function to Request Profile Resolution ---
        async function requestProfileResolution(did, buttonElement) {
            if (!did || !buttonElement) return;

            buttonElement.disabled = true;
            buttonElement.textContent = 'Requesting...';

            try {
                // This calls the new backend endpoint we created.
                const response = await fetch(`${API_BASE_URL}${API_PREFIX}/profiles/resolve/${did}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    buttonElement.textContent = 'Requested ‚úî';
                    buttonElement.style.backgroundColor = '#d4edda'; // light green
                    buttonElement.style.borderColor = '#c3e6cb';
                    // Give user feedback to refresh the list to see the update.
                    setTimeout(() => {
                        buttonElement.textContent = 'Refresh list';
                        buttonElement.disabled = false;
                    }, 2500);
                } else {
                    const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
                    throw new Error(`Status ${response.status}: ${errorData.detail}`);
                }
            } catch (error) {
                console.error(`Failed to request resolution for DID ${did}:`, error);
                buttonElement.textContent = 'Failed ‚ùå';
                buttonElement.style.backgroundColor = '#f8d7da'; // light red
                buttonElement.style.borderColor = '#f5c6cb';
            }
        }

        function loadSpecificAggregate(aggName) {
            const feedId = feedSelect.value;
            const config = AGGREGATE_CONFIGS[aggName];
            if (!feedId || !config) return;
            const timeframe = config.timeframe || timeframeSelect.value;
            if (config.renderer === 'link_cards') {
                fetchAndRenderLinkCards(feedId, aggName, timeframe, config.containerId, config.dataKey, config.fallbackMessage);
            } else if (config.renderer === 'media') {
                fetchAndRenderMediaGrid(feedId, aggName, timeframe, config.containerId, config.dataKey, config.fallbackMessage);
            }else {
                fetchAndRenderAggregate(feedId, aggName, timeframe, config.containerId, config.dataKey, config.itemNameKey, config.countKey, config.fallbackMessage);
            }
        }

        // --- Master Load Function ---
        function loadAllFeedData() {
            const feedId = feedSelect.value;
            const selectedTimeframe = timeframeSelect.value;

            if (!feedId) {
                alert("Please select a feed.");
                return;
            }

            // --- Refactored to use AGGREGATE_CONFIGS ---
            // This loops through all defined aggregates and loads them.
            for (const aggName in AGGREGATE_CONFIGS) {
                loadSpecificAggregate(aggName);
            }

            // Recent posts moved to the bottom
            fetchAndDisplayPosts(feedId);
        }

        // --- New Fetch and Render Function for Link Cards ---
        async function fetchAndRenderLinkCards(feedId, aggName, timeframe, containerId, dataKey, fallbackMessage) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<p class="loading">Loading ${fallbackMessage.toLowerCase()}...</p>`;

            try {
                const response = await fetch(`${API_BASE_URL}${API_PREFIX}/feeds/${feedId}/aggregates?agg_name=${aggName}&timeframe=${timeframe}`);
                if (!response.ok) {
                    const errorJson = await response.json().catch(() => ({}));
                    throw new Error(`HTTP error! Status: ${response.status}, Detail: ${errorJson.detail || 'Unknown error'}`);
                }
                const data = await response.json();
                const items = data && data.data_json ? data.data_json[dataKey] : [];

                if (!items || items.length === 0) {
                    container.innerHTML = `<p class="loading">No ${fallbackMessage.toLowerCase()} found for Feed ID ${feedId} in the last ${timeframe}.</p>`;
                    return;
                }

                const ul = document.createElement('ul');
                ul.classList.add('aggregate-list');
                items.forEach(item => {
                    const li = document.createElement('li');
                    const title = item.title || item.uri.substring(0, 50) + '...';
                    const description = item.description ? `<br><small style="color: #666;">${item.description.substring(0, 100)}...</small>` : '';
                    const thumbnail = item.thumbnail_url ? `<img src="${item.thumbnail_url}" alt="thumbnail" style="width:40px; height:40px; border-radius:4px; margin-right:10px; object-fit: cover;">` : '';

                    li.innerHTML = `
                        <div style="display: flex; align-items: center; flex-grow: 1; overflow: hidden;">
                            ${thumbnail}
                            <div style="overflow: hidden; text-overflow: ellipsis;">
                                <a href="${item.uri}" target="_blank" style="word-break: break-all; font-weight: bold;">${title}</a>
                                ${description}
                            </div>
                        </div>
                        <span class="count">${item.count}</span>
                    `;
                    ul.appendChild(li);
                });
                container.innerHTML = '';
                container.appendChild(ul);

            } catch (error) {
                handleFetchError(error, container, `load ${fallbackMessage.toLowerCase()}`, feedId);
            }
        }

        // --- New Fetch and Render Function for Media Grids (Videos/Images) ---
        async function fetchAndRenderMediaGrid(feedId, aggName, timeframe, containerId, dataKey, fallbackMessage) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<p class="loading">Loading ${fallbackMessage.toLowerCase()}...</p>`;

            try {
                const response = await fetch(`${API_BASE_URL}${API_PREFIX}/feeds/${feedId}/aggregates?agg_name=${aggName}&timeframe=${timeframe}`);
                if (!response.ok) {
                    const errorJson = await response.json().catch(() => ({}));
                    throw new Error(`HTTP error! Status: ${response.status}, Detail: ${errorJson.detail || 'Unknown error'}`);
                }
                const data = await response.json();
                const items = data && data.data_json ? data.data_json[dataKey] : [];

                if (!items || items.length === 0) {
                    container.innerHTML = `<p class="loading">No ${fallbackMessage.toLowerCase()} found for Feed ID ${feedId} in the last ${timeframe}.</p>`;
                    return;
                }

                const gridContainer = document.createElement('div');
                gridContainer.classList.add('media-grid');

                items.forEach(item => {
                    const postUri = item.uri;
                    const postText = item.text || 'View post';

                    if (!postUri) return; // Skip items without a post URI

                    const link = document.createElement('a');
                    link.href = `https://bsky.app/profile/${item.author_did}/post/${postUri.split('/').pop()}`;
                    link.target = '_blank';
                    link.title = `‚ù§Ô∏è ${item.like_count || 0} | üîÑ ${item.repost_count || 0}\n\n${postText}`;
                    link.classList.add('media-item');

                    // Case 1: It's an image post
                    if (item.images && item.images.length > 0) {
                        const firstImage = item.images[0];
                        const img = document.createElement('img');
                        img.src = firstImage.url;
                        img.alt = firstImage.alt || postText.substring(0, 50); // Use real alt text or fallback
                        link.appendChild(img);

                        // Add a badge if there are multiple images
                        if (item.images.length > 1) {
                            const badge = document.createElement('span');
                            badge.classList.add('image-count-badge');
                            badge.textContent = `1/${item.images.length}`;
                            link.appendChild(badge);
                        }

                        gridContainer.appendChild(link);
                    } 
                    // Case 2: It's a video post
                    else if (aggName === 'top_videos') {
                        // Apply aspect ratio styling first, so the container has the right shape
                        if (item.aspect_ratio_width && item.aspect_ratio_height) {
                            link.style.aspectRatio = `${item.aspect_ratio_width} / ${item.aspect_ratio_height}`;
                            link.style.paddingTop = '0'; // Override the CSS 1:1 hack
                        }

                        // If a thumbnail is available for the video, display it
                        if (item.thumbnail_url) {
                            const img = document.createElement('img');
                            img.src = item.thumbnail_url;
                            img.alt = `Video thumbnail: ${postText.substring(0, 50)}`;
                            link.appendChild(img);
                        } else {
                            // Otherwise, show the generic dark placeholder
                            link.classList.add('video-placeholder');
                        }

                        // Always add a play icon on top of videos (whether it's a thumbnail or placeholder)
                        const playIcon = document.createElement('div');
                        playIcon.classList.add('play-icon');
                        playIcon.textContent = '‚ñ∂';
                        link.appendChild(playIcon);
                        gridContainer.appendChild(link);
                    }
                });

                if (gridContainer.hasChildNodes()) {
                    container.innerHTML = '';
                    container.appendChild(gridContainer);
                } else {
                    // This handles the case where items existed but none had valid media to render.
                    container.innerHTML = `<p class="loading">No valid ${fallbackMessage.toLowerCase()} found for Feed ID ${feedId} in the last ${timeframe}.</p>`;
                }
            } catch (error) {
                handleFetchError(error, container, `load ${fallbackMessage.toLowerCase()}`, feedId);
            }
        }

        // --- NEW: User Profile Modal Functions ---
        function closeUserProfileModal() {
            const modal = document.getElementById('user-profile-modal');
            modal.style.display = 'none';
            document.body.classList.remove('modal-open');
        }

        // --- NEW: Hashtag Explorer Modal Functions ---
        function closeHashtagModal() {
            const modal = document.getElementById('hashtag-explorer-modal');
            modal.style.display = 'none';
            document.body.classList.remove('modal-open');
        }

        function openHashtagModal(hashtag) {
            const modal = document.getElementById('hashtag-explorer-modal');
            const modalTitle = document.getElementById('hashtag-modal-title');
            const modalInfo = document.getElementById('hashtag-modal-info');

            // Show modal and set initial state
            modal.style.display = 'flex';
            document.body.classList.add('modal-open');

            const searchLink = document.createElement('a');
            searchLink.href = `https://bsky.app/search?q=${encodeURIComponent('#' + hashtag)}`;
            searchLink.target = '_blank';
            searchLink.title = `Search for #${hashtag} on Bluesky`;
            searchLink.textContent = `Posts with #${hashtag}`;
            modalTitle.innerHTML = '';
            modalTitle.appendChild(searchLink);

            const count = hashtagCounts[hashtag.toLowerCase()];
            const timeframeText = timeframeSelect.options[timeframeSelect.selectedIndex].text;
            modalInfo.textContent = count !== undefined ? `Used ${count} time${count === 1 ? '' : 's'} in this feed (${timeframeText})` : '';

            // Fetch the first page of results
            fetchHashtagPage(hashtag, 1);
        }

        async function fetchHashtagPage(hashtag, page) {
            const modalBody = document.getElementById('hashtag-modal-body');
            const modalFooter = document.getElementById('hashtag-modal-footer');
            const feedId = feedSelect.value;
            const timeframe = timeframeSelect.value;
            const limit = 50;
            const skip = (page - 1) * limit;

            modalBody.innerHTML = `<div class="loading" style="padding: 50px;"><p>Loading posts for #${hashtag}...</p></div>`;
            modalFooter.innerHTML = ''; // Clear old pagination

            try {
                const response = await fetch(`${API_BASE_URL}${API_PREFIX}/feeds/${feedId}/posts/by_hashtag/${hashtag}?timeframe=${timeframe}&limit=${limit}&skip=${skip}`);
                if (!response.ok) {
                    const errorJson = await response.json().catch(() => ({}));
                    throw new Error(`HTTP error! Status: ${response.status}, Detail: ${errorJson.detail || 'Unknown error'}`);
                }
                const data = await response.json();
                const posts = data.posts;
                const total = data.total;

                if (!posts || posts.length === 0) {
                    modalBody.innerHTML = `<p class="loading">No posts found on this page.</p>`;
                } else {
                    modalBody.innerHTML = ''; // Clear loading message
                    const postsGrid = document.createElement('div');
                    postsGrid.classList.add('posts-grid');
                    posts.forEach(post => {
                        const postElement = createPostCardElement(post);
                        postsGrid.appendChild(postElement);
                    });
                    modalBody.appendChild(postsGrid);
                }

                renderHashtagPagination(hashtag, page, limit, total);

            } catch (error) {
                handleFetchError(error, modalBody, `load posts for #${hashtag}`);
            }
        }

        function renderHashtagPagination(hashtag, currentPage, limit, total) {
            const modalFooter = document.getElementById('hashtag-modal-footer');
            modalFooter.innerHTML = '';

            const totalPages = Math.ceil(total / limit);
            if (totalPages <= 1) return;

            const prevButton = document.createElement('button');
            prevButton.textContent = '‚Äπ Previous';
            prevButton.disabled = currentPage === 1;
            prevButton.onclick = () => fetchHashtagPage(hashtag, currentPage - 1);

            const nextButton = document.createElement('button');
            nextButton.textContent = 'Next ‚Ä∫';
            nextButton.disabled = currentPage >= totalPages;
            nextButton.onclick = () => fetchHashtagPage(hashtag, currentPage + 1);
            
            const pageInfo = document.createElement('span');
            pageInfo.className = 'page-info';
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;

            modalFooter.appendChild(prevButton);
            modalFooter.appendChild(pageInfo);
            modalFooter.appendChild(nextButton);
        }

        async function openUserProfileModal(user) {
            const modal = document.getElementById('user-profile-modal');
            const contentArea = document.getElementById('modal-content-area');
            const feedId = feedSelect.value;

            modal.style.display = 'flex';
            document.body.classList.add('modal-open');
            contentArea.innerHTML = `<div class="loading" style="padding: 50px;"><p>Loading profile for @${user.handle}...</p></div>`;

            try {
                // --- REAL API CALLS ---
                // Fetch all profile data concurrently for speed
                const [profileRes, statsRes, achievementsRes, inProgressRes, postsRes] = await Promise.all([
                    fetch(`${API_BASE_URL}${API_PREFIX}/profiles/${user.did}/details`),
                    fetch(`${API_BASE_URL}${API_PREFIX}/profiles/${user.did}/stats/${feedId}`),
                    fetch(`${API_BASE_URL}${API_PREFIX}/profiles/${user.did}/achievements`),
                    fetch(`${API_BASE_URL}${API_PREFIX}/profiles/${user.did}/achievements/in-progress`),
                    fetch(`${API_BASE_URL}${API_PREFIX}/feeds/${feedId}/posts/by_author/${user.did}?limit=5`)
                ]);

                // Check all responses for errors
                if (!profileRes.ok) throw new Error(`Failed to load profile details: ${profileRes.statusText}`);
                if (!statsRes.ok) throw new Error(`Failed to load feed stats: ${statsRes.statusText}`);
                if (!achievementsRes.ok) throw new Error(`Failed to load achievements: ${achievementsRes.statusText}`);
                if (!inProgressRes.ok) throw new Error(`Failed to load in-progress achievements: ${inProgressRes.statusText}`);
                if (!postsRes.ok) throw new Error(`Failed to load recent posts: ${postsRes.statusText}`);

                const profileDetails = await profileRes.json();
                const feedStats = await statsRes.json();
                const achievements = await achievementsRes.json();
                const inProgressAchievements = await inProgressRes.json();
                const recentPosts = await postsRes.json();

                // Backend already sorts by rarity, but this is a good client-side confirmation.
                achievements.sort((a, b) => (a.achievement.rarity_percentage || 100) - (b.achievement.rarity_percentage || 100));

                // --- Render the modal with real data ---
                contentArea.innerHTML = `
                    <div class="modal-header">
                        <img src="${user.avatarUrl}" alt="${user.handle}'s avatar">
                        <div class="user-details">
                            <h3>${user.displayName || user.handle}</h3>
                            <p>@${user.handle}</p>
                            <p style="font-size: 0.9em; color: #333;">${profileDetails.description || 'No bio available.'}</p>
                            <p style="font-size: 0.8em; color: #666;">
                                <strong>${profileDetails.followers_count || 0}</strong> Followers | 
                                <strong>${profileDetails.following_count || 0}</strong> Following
                            </p>
                        </div>
                    </div>
                    <div class="modal-body modal-grid-body">
                        <!-- Left Column -->
                        <div class="modal-grid-column">
                            <div class="modal-section">
                                <h4 class="section-title" style="margin-top:0;">Stats in this Feed</h4>
                                ${feedStats && feedStats.post_count > 0 ? `
                                    <ul class="aggregate-list">
                                        <li>Total Posts: <span class="count">${feedStats.post_count || 0}</span></li>
                                        <li>Total Likes Received: <span class="count">${feedStats.total_likes_received || 0}</span></li>
                                        <li>Total Reposts Received: <span class="count">${feedStats.total_reposts_received || 0}</span></li>
                                        <li>First Post: <span class="count">${feedStats.first_post_at ? new Date(feedStats.first_post_at).toLocaleDateString() : 'N/A'}</span></li>
                                    </ul>
                                ` : '<p>No stats available for this user in this feed.</p>'}
                            </div>
                            <div class="modal-section">
                                <h4 class="section-title">Recent Posts in this Feed</h4>
                                <div class="scrollable-list">
                                    ${recentPosts && recentPosts.posts && recentPosts.posts.length > 0 ? `
                                        ${recentPosts.posts.map(post => {
                                            const postRkey = post.uri.split('/').pop();
                                            const postUrl = `https://bsky.app/profile/${user.handle}/post/${postRkey}`;
                                            return `
                                                <a href="${postUrl}" target="_blank" class="post-card" style="margin-bottom: 15px; box-shadow: none; border: 1px solid #eee; text-decoration: none; color: inherit; display: block; cursor: pointer;">
                                                    <div class="post-text" style="margin-bottom: 8px;">${post.text || 'No text content.'}</div>
                                                    <div class="post-engagement" style="font-size: 0.8em; text-align: right;">
                                                        <small style="float: left; color: #666;">${new Date(post.created_at).toLocaleDateString()}</small>
                                                        <span class="icon-heart">${post.like_count || 0}</span>
                                                        <span class="icon-repost">${post.repost_count || 0}</span>
                                                        <span class="icon-reply">${post.reply_count || 0}</span>
                                                        <span class="icon-quote">${post.quote_count || 0}</span>
                                                    </div>
                                                </a>
                                            `;
                                        }).join('')}
                                    ` : '<p>No recent posts by this user in this feed.</p>'}
                                </div>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div class="modal-grid-column">
                            <div class="modal-section">
                                <h4 class="section-title" style="margin-top:0;">Achievements</h4>
                                ${achievements && achievements.length > 0 ? `
                                    <ul class="aggregate-list scrollable-list">
                                        ${achievements.map(userAch => {
                                            const ach = userAch.achievement;

                                            // Determine the type icon and context text for the percentage
                                            const isGlobal = ach.type === 'global';
                                            const typeIcon = isGlobal
                                                ? '<span title="Global Achievement" style="margin-right: 8px; cursor: help;">üåç</span>'
                                                : '<span title="Feed-Specific Achievement" style="margin-right: 8px; cursor: help;">üì∞</span>';
                                            const percentageContext = isGlobal ? 'of users globally' : 'of users in this feed';

                                            // Determine the rarity tier (use the clean `rarity_tier` field)
                                            const rarityTier = ach.rarity_tier || 'Bronze'; // Fallback to Bronze

                                            // Construct the percentage text
                                            const percentageText = ach.rarity_percentage != null
                                                ? `${ach.rarity_percentage.toFixed(2)}% ${percentageContext}`
                                                : '';

                                            // Construct the full list item
                                            return `
                                                <li>
                                                    <div style="flex-grow: 1; margin-right: 15px;">
                                                        <strong style="display: flex; align-items: center;">
                                                            ${typeIcon}
                                                            <span>
                                                                ${ach.name}
                                                                ${userAch.feed ? `<span style="font-style: italic; color: #555; font-weight: normal;"> (in ${userAch.feed.name})</span>` : ''}
                                                            </span>
                                                        </strong>
                                                        <small style="display: block; color: #666; padding-left: 28px;">${ach.description}</small>
                                                    </div>
                                                    <div style="display: flex; flex-direction: column; align-items: flex-end; text-align: right; white-space: nowrap;">
                                                        <div style="display: flex; align-items: center; gap: 8px;">
                                                            <span style="font-size: 1.5em;">${getIconForRarity(rarityTier)}</span>
                                                            <span class="rarity-label rarity-${rarityTier.toLowerCase()}">${rarityTier}</span>
                                                        </div>
                                                        <small style="color: #888; font-size: 0.9em; margin-top: 4px; font-style: italic;">
                                                            ${percentageText}
                                                        </small>
                                                    </div>
                                                </li>
                                            `;
                                        }).join('')}
                                    </ul>
                                ` : '<p>No achievements earned yet.</p>'}
                            </div>

                            <div class="modal-section">
                                <h4 class="section-title">In Progress</h4>
                                ${inProgressAchievements && inProgressAchievements.length > 0 ? `
                                    <ul class="aggregate-list scrollable-list">
                                        ${inProgressAchievements.map(progAch => {
                                            const ach = progAch.achievement;
                                            const isGlobal = ach.type === 'global';
                                            const typeIcon = isGlobal
                                                ? '<span title="Global Achievement" style="margin-right: 8px; cursor: help;">üåç</span>'
                                                : '<span title="Feed-Specific Achievement" style="margin-right: 8px; cursor: help;">üì∞</span>';

                                            return `
                                                <li style="flex-direction: column; align-items: flex-start; gap: 5px;">
                                                    <div style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
                                                        <div style="flex-grow: 1; margin-right: 15px;">
                                                            <strong style="display: flex; align-items: center;">
                                                                ${typeIcon}
                                                                <span>
                                                                    ${ach.name}
                                                                    ${progAch.feed ? `<span style="font-style: italic; color: #555; font-weight: normal;"> (in ${progAch.feed.name})</span>` : ''}
                                                                </span>
                                                            </strong>
                                                            <small style="display: block; color: #666; padding-left: 28px;">${ach.description}</small>
                                                        </div>
                                                        <div style="white-space: nowrap; font-weight: bold; color: #333; font-size: 0.9em;">
                                                            ${Math.round(progAch.current_value)} / ${progAch.required_value}
                                                        </div>
                                                    </div>
                                                    <div class="progress-bar-container">
                                                        <div class="progress-bar" style="width: ${progAch.progress_percentage.toFixed(2)}%;"></div>
                                                    </div>
                                                </li>
                                            `;
                                        }).join('')}
                                    </ul>
                                ` : '<p>No achievements currently in progress.</p>'}
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                handleFetchError(error, contentArea, `load profile for @${user.handle}`);
            }
        }

        const getIconForRarity = (rarityLabel) => {
            const icons = {
                'Mythic': '‚ú®',
                'Legendary': 'üëë',
                'Diamond': 'üí†',
                'Platinum': 'üíø',
                'Gold': 'ü•á',
                'Silver': 'ü•à',
                'Bronze': 'ü•â',
            };
            return icons[rarityLabel] || 'üèÖ'; // Fallback icon
        };

        // --- NEW: Search Functionality ---
        const searchInput = document.getElementById('searchInput');
        const searchResultsContainer = document.getElementById('search-results-container');
        const searchResultsContent = document.getElementById('search-results-content');
        const searchResultsTitle = document.getElementById('search-results-title');

        async function handleSearch() {
            const query = searchInput.value.trim();

            if (query.length < 3) {
                searchResultsContainer.style.display = 'none';
                return;
            }

            searchResultsContainer.style.display = 'block';
            searchResultsTitle.textContent = `Search Results for "${query}"`;
            searchResultsContent.innerHTML = `<p class="loading">Searching...</p>`;

            try {
                const response = await fetch(`${API_BASE_URL}${API_PREFIX}/search?q=${encodeURIComponent(query)}`);
                if (!response.ok) {
                    const errorJson = await response.json().catch(() => ({}));
                    throw new Error(`HTTP error! Status: ${response.status}, Detail: ${errorJson.detail || 'Unknown error'}`);
                }
                const data = await response.json();

                if (!data.users || data.users.length === 0) {
                    searchResultsContent.innerHTML = `<p class="loading">No users found matching "${query}".</p>`;
                    return;
                }

                const ul = document.createElement('ul');
                ul.classList.add('aggregate-list');
                data.users.forEach(item => {
                    const li = document.createElement('li');

                    const handle = item.handle;
                    const displayName = item.display_name;
                    const did = item.did;
                    const avatarUrl = item.avatar_url || 'https://via.placeholder.com/24';

                    const userContent = (displayName && displayName.trim() !== '')
                        ? `<div style="display: flex; flex-direction: column; line-height: 1.2;">
                               <strong style="color: #333;">${displayName}</strong>
                               <small style="color: #666;">@${handle}</small>
                           </div>`
                        : `<div style="display: flex; align-items: center;"><strong style="color: #333;">@${handle}</strong></div>`;
                    
                    const userLink = `<a href="javascript:void(0)" onclick="openUserProfileModal({ did: '${did}', handle: '${handle}', displayName: '${(displayName || '').replace(/'/g, "\\'")}', avatarUrl: '${avatarUrl}' })" style="text-decoration: none; color: inherit; display: flex; align-items: center; flex-grow: 1;">
                                <img src="${avatarUrl}" alt="Avatar" style="width:32px; height:32px; border-radius:50%; margin-right:12px; vertical-align: middle;">
                                ${userContent}
                            </a>`;

                    li.innerHTML = userLink;
                    ul.appendChild(li);
                });
                searchResultsContent.innerHTML = '';
                searchResultsContent.appendChild(ul);

            } catch (error) {
                handleFetchError(error, searchResultsContent, `perform search for "${query}"`);
            }
        }

        // Event Listeners
        loadDataBtn.addEventListener('click', loadAllFeedData);
        feedSelect.addEventListener('change', loadAllFeedData);
        timeframeSelect.addEventListener('change', () => {
            if (feedSelect.value) loadAllFeedData();
        });
        searchInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                handleSearch();
            }
        });

        // Initial load with default value (e.g., 3654) and default timeframe
        document.addEventListener('DOMContentLoaded', () => {
            loadAllFeedData();
        });
    </script>
</body>
</html>